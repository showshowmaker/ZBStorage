# ZBStorage TODO（不足与改进项）

> 目标：明确当前原型的短板，按优先级推进到可稳定运行的工程版本。

## P0（必须优先解决）

- [ ] **元数据高可用不足**：MDS 目前是单实例 RocksDB，本身没有主从/共识，MDS 故障会导致全局不可用。  
  - 改进：引入 MDS 主从（WAL 同步）或基于 Raft 的多副本元数据服务。

- [ ] **写入一致性链路不完整**：数据节点主从复制存在，但缺少端到端事务语义（MDS 分配、DataNode 写入、MDS 提交之间无统一事务）。  
  - 改进：增加两阶段提交/幂等日志（allocate_txn_id + commit/abort）。

- [ ] **故障恢复流程不完善**：主从切换后，旧主追平、脑裂防护、epoch 栅栏策略仍需加强。  
  - 改进：严格 epoch 校验 + fencing token + failback 流程。

- [ ] **安全机制缺失**：RPC 未做认证鉴权和传输加密。  
  - 改进：mTLS、节点证书、接口级 ACL、管理接口鉴权。

- [ ] **数据校验不足**：chunk 没有统一 checksum/校验恢复流程，潜在静默损坏风险。  
  - 改进：写入计算 checksum，读取校验，坏块自动回源修复。

## P1（稳定性与性能）

- [ ] **光盘归档能力是 MVP**：当前为模拟镜像刻录，归档任务调度、失败重试、断点续传、并发控制仍偏基础。  
  - 改进：任务状态机持久化、指数退避重试、速率限制、任务幂等键。

- [ ] **冷热分层策略较粗**：当前主要按阈值和 atime TTL 处理，策略维度有限。  
  - 改进：支持按目录/租户/文件类型策略，加入 LRU+成本模型。

- [ ] **调度器可用性不足**：Scheduler 目前单实例，控制面故障时心跳与运维能力下降。  
  - 改进：Scheduler 主备或无状态 + 外部存储。

- [ ] **观测能力不够**：缺少标准 metrics、trace、慢请求分析。  
  - 改进：Prometheus 指标、OpenTelemetry tracing、统一日志字段。

- [ ] **限流与背压不足**：高并发下缺少分层限流（客户端/MDS/节点）。  
  - 改进：全链路 QPS、带宽、并发连接、队列水位控制。

## P2（工程化与生态）

- [ ] **测试覆盖不足**：缺少系统级故障注入测试（节点宕机、网络抖动、磁盘满、重启恢复）。  
  - 改进：增加 chaos 测试和端到端回归脚本（CI 自动执行）。

- [ ] **K8s 生产化细节不足**：部署脚本示例化较强，缺少完善的探针/资源配额/PDB/滚动升级策略。  
  - 改进：补全 Helm Chart、liveness/readiness、优雅下线策略。

- [ ] **跨平台构建体验不一致**：Windows 开发、Linux 运行场景下依赖（brpc/gflags/fuse）配置成本高。  
  - 改进：统一 devcontainer 或 Docker build 环境，固定依赖版本。

- [ ] **协议兼容治理不足**：proto 演进规则和版本兼容策略未系统化。  
  - 改进：引入协议版本字段、兼容矩阵、变更检查流程。

---

## 建议的近期里程碑

1. **M1（可用性）**：MDS 高可用 + 写入事务化 + 基础认证。  
2. **M2（稳定性）**：故障注入测试集 + 监控告警 + 自动修复链路。  
3. **M3（分层存储）**：光盘归档任务系统完善 + 冷数据策略可配置化。  
4. **M4（生产化）**：K8s 标准化部署与升级回滚流程。
